#!/usr/bin/env hhvm -d hhvm.jit=false --define xdebug.remote_enable=1 --define xdebug.remote_autostart=1 --define xdebug.enable=On --define xdebug.remove_enable=false --define xhprof.output_dir=/tmp --define memory_limit=-1 --define log_errors=true --define hhvm.debug.server_error_message=true
<?hh
 
/*
// --
// Code coverage requires xdebug
// --

$command[] = '';
$command[] = '';
$command[] = '--define error_log=' . escapeshellarg($testErrorLogFile);
$command[] = '';
$command[] = '';
*/
$projectRoot = dirname(dirname(dirname(dirname(dirname(__FILE__)))));

require_once $projectRoot . '/vendor/autoload.php';
require_once $projectRoot . '/vendor/zynga/phpunit/vendor/autoload.php';

use Zynga\PHPUnit\V2\Runner;

$userName = 'unknown';

if (isset($_ENV['USER'])) {
  $userName = $_ENV['USER'];
} else {
  $userName = get_current_user();
}

$runner = new Runner($projectRoot, $userName, $argv);

exit($runner->run());

$testErrorLogFile = $projectRoot . '/tmp/php.log';

$command = array();
$command[] = PHP_BINARY;

// ---
// We don't need to run JIT for tests
// ---
$command[] = '-d hhvm.jit=false';

// ---
// Allow remote debugging
// ---
$command[] = '--define xdebug.remote_enable=1';
$command[] = '--define xdebug.remote_autostart=1';

// --
// Code coverage requires xdebug
// --
$command[] = '--define xdebug.enable=On';
$command[] = '--define xdebug.remove_enable=false';

$command[] = '--define xhprof.output_dir=/tmp';
$command[] = '--define memory_limit=-1';
$command[] = '--define error_log=' . escapeshellarg($testErrorLogFile);
$command[] = '--define log_errors=true';
$command[] = '--define hhvm.debug.server_error_message=true';

// --
// The composer version of phpunit.
// --
$command[] = escapeshellarg($projectRoot . '/vendor/bin/phpunit-vendor');

// $command[] = '--debug';
// $command[] = '--stop-on-failure';

// $command[] = '--coverage-clover=' . escapeshellarg($coverageFile);
$command[] = '--coverage-html=' . escapeshellarg($htmlDir);
$command[] = '--coverage-text';

$command[] = '--configuration=' . escapeshellarg($projectRoot . '/phpunit.xml');
// $command[] = '--testdox';

$argvCount = count($argv);
for ( $i = 1; $i < $argvCount; $i++ ) {
  $command[] = $argv[$i];
}

// var_dump($command);

$commandString = join(' ', $command);

var_dump($commandString);

$rv = 0;
passthru($commandString, $rv);

echo "CODE coverageFile=$coverageFile\n";
echo "CODE htmlDir=$htmlDir\n";
// --
// JEO:
// echo "SYMLINK=$displayLink utilize your slice name /internal/phpunit/ to view output\n";

if ( $rv == 0 ) {
  echo "OK!\n";
}

exit($rv);
